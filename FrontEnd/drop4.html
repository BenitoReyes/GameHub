<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Board Visual</title>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body class="game-page">
        <!-- Red Player Profile (Top Left) -->
        <div class="profile-container profile-left">
            <div class="profile-avatar profile-red">
                <img src="https://images.unsplash.com/photo-1557110437-0bcd0a636d62?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxibGFuayUyMHByb2ZpbGUlMjBhdmF0YXJ8ZW58MXx8fHwxNzYxMTg3ODUxfDA&ixlib=rb-4.1.0&q=80&w=1080&utm_source=figma&utm_medium=referral" alt="Red Player">
            </div>
            <span class="profile-username" id="redPlayerName">Player 1</span>
        </div>
        
        <!-- Blue Player Profile (Top Right) -->
        <div class="profile-container profile-right">
            <div class="profile-avatar profile-blue">
                <img src="https://images.unsplash.com/photo-1557110437-0bcd0a636d62?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w3Nzg4Nzd8MHwxfHNlYXJjaHwxfHxibGFuayUyMHByb2ZpbGUlMjBhdmF0YXJ8ZW58MXx8fHwxNzYxMTg3ODUxfDA&ixlib=rb-4.1.0&q=80&w=1080&utm_source=figma&utm_medium=referral" alt="Blue Player">
            </div>
            <span class="profile-username" id="bluePlayerName">Player 2</span>
        </div>

        <div class="game-wrapper">
            <div class="suggestion-controls">
                <button id="suggestionBtn" class="suggestion-button">Get Move Suggestion</button>
            </div>
            <div class="board-container">
                <div id="game-board">
                <!-- 6 rows × 7 columns = 42 cells -->
                <div class="cell" data-row="0" data-col="0"></div>
                <div class="cell" data-row="0" data-col="1"></div>
                <div class="cell" data-row="0" data-col="2"></div>
                <div class="cell" data-row="0" data-col="3"></div>
                <div class="cell" data-row="0" data-col="4"></div>
                <div class="cell" data-row="0" data-col="5"></div>
                <div class="cell" data-row="0" data-col="6"></div>
                <div class="cell" data-row="1" data-col="0"></div>
                <div class="cell" data-row="1" data-col="1"></div>
                <div class="cell" data-row="1" data-col="2"></div>
                <div class="cell" data-row="1" data-col="3"></div>
                <div class="cell" data-row="1" data-col="4"></div>
                <div class="cell" data-row="1" data-col="5"></div>
                <div class="cell" data-row="1" data-col="6"></div>
                <div class="cell" data-row="2" data-col="0"></div>
                <div class="cell" data-row="2" data-col="1"></div>
                <div class="cell" data-row="2" data-col="2"></div>
                <div class="cell" data-row="2" data-col="3"></div>
                <div class="cell" data-row="2" data-col="4"></div>
                <div class="cell" data-row="2" data-col="5"></div>
                <div class="cell" data-row="2" data-col="6"></div>
                <div class="cell" data-row="3" data-col="0"></div>
                <div class="cell" data-row="3" data-col="1"></div>
                <div class="cell" data-row="3" data-col="2"></div>
                <div class="cell" data-row="3" data-col="3"></div>
                <div class="cell" data-row="3" data-col="4"></div>
                <div class="cell" data-row="3" data-col="5"></div>
                <div class="cell" data-row="3" data-col="6"></div>
                <div class="cell" data-row="4" data-col="0"></div>
                <div class="cell" data-row="4" data-col="1"></div>
                <div class="cell" data-row="4" data-col="2"></div>
                <div class="cell" data-row="4" data-col="3"></div>
                <div class="cell" data-row="4" data-col="4"></div>
                <div class="cell" data-row="4" data-col="5"></div>
                <div class="cell" data-row="4" data-col="6"></div>
                <div class="cell" data-row="5" data-col="0"></div>
                <div class="cell" data-row="5" data-col="1"></div>
                <div class="cell" data-row="5" data-col="2"></div>
                <div class="cell" data-row="5" data-col="3"></div>
                <div class="cell" data-row="5" data-col="4"></div>
                <div class="cell" data-row="5" data-col="5"></div>
                <div class="cell" data-row="5" data-col="6"></div>
            </div>
            <div id="turnIndicator">Turn: RED</div>
        </div>
        <div class="chat-container">
            <h2>Live Chat</h2>
            <div id="chatMessages" class="chat-box"></div>
            <input id="chatInput" type="text" placeholder="Type a message..." />
            <button id="sendBtn">Send</button>
        </div>
    </div>
        <script src="stream-chat.bundle.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="script.js"></script>
        <script>
            window.addEventListener('DOMContentLoaded', async () => {
                window.IS_BOARD_PAGE = true;
                renderScores();
                const urlParams = new URLSearchParams(window.location.search);
                const checkRoomId = sessionStorage.getItem('roomId');
                if(!checkRoomId){
                    sessionStorage.setItem('roomId', urlParams.get('roomId') || '');
                }
                const roomId = urlParams.get('roomId') || sessionStorage.getItem('roomId');
                const userId = sessionStorage.getItem('userId');
                const token = sessionStorage.getItem('token');
                const role = sessionStorage.getItem('role');
                const username = sessionStorage.getItem('username');
                if (!roomId || !userId || !token || !role) {
                alert("Missing session data. Please rejoin the room.");
                return;
                }
                try {
                await connectToChat({ roomId, userId, token, role, username });
                } catch (err) {
                console.error("Error connecting to chat:", err);
                }
                assignedPlayer = role;
                currentPlayer = 'red'; // red always starts
                isMyTurn = role === currentPlayer;
                scriptRoomId = roomId;
                
                // Update player names based on role
                if (role === 'red') {
                    document.getElementById('redPlayerName').textContent = username || 'Player 1';
                    USER_ROLES[username] = 'red';
                } else if (role === 'blue') {
                    document.getElementById('bluePlayerName').textContent = username || 'Player 2';
                    USER_ROLES[username] = 'blue';
                } else if (role === 'spectator') {
                    USER_ROLES[username] = 'spectator';
                }
                
                socket.emit('join-room', scriptRoomId);
                
                // Broadcast username to other players
                socket.emit('player-joined', { roomId: scriptRoomId, role: role, username: username });
                
                // Request current player names (in case this is a refresh/rejoin)
                socket.emit('request-player-names', scriptRoomId);
                
                // Listen for all players info
                socket.on('all-players-info', (players) => {
                    if (players.red) {
                        document.getElementById('redPlayerName').textContent = players.red;
                        USER_ROLES[players.red] = 'red';
                    }
                    if (players.blue) {
                        document.getElementById('bluePlayerName').textContent = players.blue;
                        USER_ROLES[players.blue] = 'blue';
                    }
                });
                
                // Optional role alert
                if(role==='spectator'){
                    showRoleModal("You are a " + role + ", RoomID: " + roomId);
                } else {
                    showRoleModal("You are " + role + ", RoomID: " + roomId);
                }
                socket.on('sync-board', (boardData) => {
                    board = boardData;
                    updateReloadedUI(board); // ← this should redraw the board
                    updateTurnIndicator();
                });
                socket.emit('request-board', scriptRoomId);
                socket.emit('getScores', scriptRoomId);
                socket.on('scoreUpdate', ({ redScore: rScore, blueScore: bScore }) => {
                    renderScores(rScore, bScore);
                });

                // Add suggestion button functionality
                const suggestionBtn = document.getElementById('suggestionBtn');
                let previousHighlight = null;

                function removeHighlight() {
                    if (previousHighlight !== null) {
                        const cells = document.querySelectorAll(`.cell[data-col="${previousHighlight}"]`);
                        cells.forEach(cell => cell.classList.remove('column-highlight'));
                        previousHighlight = null;
                    }
                }

                function highlightColumn(column) {
                    removeHighlight();
                    const cells = document.querySelectorAll(`.cell[data-col="${column}"]`);
                    cells.forEach(cell => cell.classList.add('column-highlight'));
                    previousHighlight = column;

                    // Remove highlight after 3 seconds
                    setTimeout(removeHighlight, 3000);
                }

                async function getSuggestion() {
                    // Check if it's the user's turn
                    if (!isMyTurn) {
                        alert("Please wait for your turn!");
                        return;
                    }

                    try {
                        // Use the game's `board` variable (from script.js). Convert empty (0) to null
                        const boardState = (typeof board !== 'undefined')
                            ? board.map(row => row.map(cell => cell === 0 ? null : cell))
                            : Array.from({ length: 6 }, () => Array(7).fill(null));

                        // currentPlayer is maintained by the main game script; use it if available
                        const playerToSend = typeof currentPlayer !== 'undefined' ? currentPlayer : 'red';

                        // Make the API call
                        const response = await fetch('/api/drop4/suggest', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                board: boardState,
                                currentPlayer: playerToSend
                            }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to get suggestion');
                        }

                        const data = await response.json();
                        if (data.column >= 0) {
                            highlightColumn(data.column);
                        } else {
                            alert('No valid moves available');
                        }
                    } catch (error) {
                        console.error('Error getting suggestion:', error);
                        alert('Failed to get move suggestion. Please try again.');
                    }
                }

                // Add click event listener to suggestion button
                suggestionBtn.addEventListener('click', getSuggestion);

                // Update suggestion button visibility based on role
                function updateSuggestionButtonVisibility() {
                    if (role === 'spectator') {
                        suggestionBtn.style.display = 'none';
                    } else {
                        suggestionBtn.style.display = 'block';
                    }
                }
                updateSuggestionButtonVisibility();

                // Now that DOM is ready and role is assigned, initialize board
                initializeBoard();
            });
            let hasLeft = false;

            function notifyLeaveGame() {
                if (hasLeft) return; // prevent double execution
                hasLeft = true;
                const roomId = sessionStorage.getItem('roomId');
                if (roomId) {
                    socket.emit('leave-game', roomId);
                    console.log('leave-game emitted for room:', roomId);
                }
            }


            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    notifyLeaveGame();
                    // Page is hidden due to tab switch or app backgrounding
                    // This might not reliably fire on reload/back nav in Safari

                }
            });

            window.addEventListener('pagehide', function() {
                notifyLeaveGame();
                // Page is being navigated away from (including reload or back/forward)
                // This is more reliable for detecting unload scenarios in Safari
            });
        </script>
    </body>
</html>