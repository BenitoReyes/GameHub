<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drop4 - Single Player</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .controls { display:flex; gap:12px; align-items:center; justify-content:center; margin-top:12px }
    .difficulty { padding:8px 12px; border-radius:6px; border:2px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.12); color:inherit }
    .small { font-size:13px }
    #suggestionBtn { display:none }
  </style>
</head>
<body class="game-page">
  <a href="drop4Menu.html" class="back-btn">◄ BACK</a>
  <div class="profile-container profile-left">
    <div class="profile-avatar profile-red"><img alt="You" src="Assets/player-red.png"/></div>
    <span class="profile-username" id="redPlayerName">You</span>
  </div>
  <div class="profile-container profile-right">
    <div class="profile-avatar profile-blue"><img alt="AI" src="Assets/player-blue.png"/></div>
    <span class="profile-username" id="bluePlayerName">Computer</span>
  </div>

  <div class="game-wrapper">
    <div class="controls">
      <label class="small">Difficulty:</label>
      <select id="difficulty" class="difficulty">
        <option value="2">Easy</option>
        <option value="4" selected>Medium</option>
        <option value="6">Hard</option>
      </select>
      <button id="newGameBtn" class="suggestion-button">New Game</button>
    </div>

    <div class="board-container">
      <div id="game-board">
        <!-- cells generated by script -->
      </div>
      <div id="turnIndicator">Turn: RED</div>
    </div>
  </div>

  <script>
    // Minimal single-player game logic reusing existing styles and assets
    const ROWS = 6, COLS = 7;
    const PLAYER_RED = 'red', PLAYER_BLUE = 'blue';
    let board = Array.from({length: ROWS}, ()=> Array(COLS).fill(0)); // 0 empty, 'red' or 'blue'
    let currentPlayer = PLAYER_RED; // red starts (human)
    let gameOver = false;

    const boardEl = document.getElementById('game-board');
    const turnEl = document.getElementById('turnIndicator');
    const difficultyEl = document.getElementById('difficulty');
    const newGameBtn = document.getElementById('newGameBtn');

    function renderBoard(){
      boardEl.innerHTML = '';
      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.addEventListener('click', ()=> onCellClick(c));
          boardEl.appendChild(cell);
          const val = board[r][c];
          if(val && (val === 'red' || val === 'blue')){
            const img = document.createElement('img');
            img.className = 'piece ' + val;
            img.src = val === 'red' ? 'Assets/GHCCoin.png' : 'Assets/GHRBCoin.png';
            cell.appendChild(img);
          }
        }
      }
      updateTurnIndicator();
    }

    function updateTurnIndicator(){
      if(gameOver){ turnEl.textContent = 'Game Over'; return; }
      if(currentPlayer === PLAYER_RED){ turnEl.textContent = 'Turn: RED'; turnEl.className = 'red'; }
      else { turnEl.textContent = 'Turn: BLUE'; turnEl.className = 'blue'; }
    }

    function dropLocal(col, player){
      for(let r=ROWS-1;r>=0;r--){
        if(board[r][col] === 0){ board[r][col] = player; return r; }
      }
      return -1;
    }

    function checkWinLocal(player){
      // horizontal
      for(let r=0;r<ROWS;r++){
        for(let c=0;c<=COLS-4;c++){
          if(board[r][c]===player && board[r][c+1]===player && board[r][c+2]===player && board[r][c+3]===player) return true;
        }
      }
      // vertical
      for(let c=0;c<COLS;c++){
        for(let r=0;r<=ROWS-4;r++){
          if(board[r][c]===player && board[r+1][c]===player && board[r+2][c]===player && board[r+3][c]===player) return true;
        }
      }
      // diag TL-BR
      for(let r=0;r<=ROWS-4;r++){
        for(let c=0;c<=COLS-4;c++){
          if(board[r][c]===player && board[r+1][c+1]===player && board[r+2][c+2]===player && board[r+3][c+3]===player) return true;
        }
      }
      // diag BL-TR (bottom-left to top-right)
      for(let r=3;r<ROWS;r++){
        for(let c=0;c<=COLS-4;c++){
          if(board[r][c]===player && board[r-1][c+1]===player && board[r-2][c+2]===player && board[r-3][c+3]===player) return true;
        }
      }
      return false;
    }

    function isBoardFull(){
      return board.every(row => row.every(cell => cell !== 0));
    }

    async function onCellClick(col){
      if(gameOver) return;
      if(currentPlayer !== PLAYER_RED) return; // only allow human
      const row = dropLocal(col, PLAYER_RED);
      if(row === -1) return;
      renderBoard();
      if(checkWinLocal(PLAYER_RED)){
        gameOver = true; updateTurnIndicator(); setTimeout(()=>alert('You win!'), 50); return;
      }
      if(isBoardFull()){ gameOver = true; setTimeout(()=>alert('Draw!'), 50); return; }
      // switch to AI
      currentPlayer = PLAYER_BLUE; updateTurnIndicator();
      await aiMove();
    }

    async function aiMove(){
      // Prepare board for API: convert 0 to null
      const boardForApi = board.map(r => r.map(c => c === 0 ? null : c));
      const depth = parseInt(difficultyEl.value, 10) || 4;
      try{
        const res = await fetch('/api/drop4/suggest', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ board: boardForApi, currentPlayer: PLAYER_BLUE, depth })
        });
        if(!res.ok) throw new Error('AI request failed');
        const data = await res.json();
        const col = data.column;
        if(typeof col !== 'number' || col < 0 || col >= COLS){
          // fallback: choose first available
          for(let c=0;c<COLS;c++){ if(board[0][c]===0){ applyAiCol(c); break; } }
        } else {
          applyAiCol(col);
        }
      }catch(err){
        console.error('AI error',err);
        // fallback random
        for(let c=0;c<COLS;c++){ if(board[0][c]===0){ applyAiCol(c); break; } }
      }
    }

    function applyAiCol(col){
      const row = dropLocal(col, PLAYER_BLUE);
      renderBoard();
      if(checkWinLocal(PLAYER_BLUE)){
        gameOver = true; updateTurnIndicator(); setTimeout(()=>alert('Computer wins!'), 50); return;
      }
      if(isBoardFull()){ gameOver = true; setTimeout(()=>alert('Draw!'), 50); return; }
      currentPlayer = PLAYER_RED; updateTurnIndicator();
    }

    function newGame(){
      board = Array.from({length: ROWS}, ()=> Array(COLS).fill(0));
      currentPlayer = PLAYER_RED; gameOver=false; renderBoard();
    }

    newGameBtn.addEventListener('click', ()=> newGame());

    // initial render
    // build empty grid in DOM structure compatible with styles (grid is defined in styles.css by #game-board)
    // ensure grid-template etc are already set in styles.css
    (function init(){
      // create grid cells in correct order so CSS grid places them in 7 columns × 6 rows
      // but we render them row by row
      boardEl.style.display = 'grid';
      boardEl.style.gridTemplateColumns = 'repeat(7,1fr)';
      boardEl.style.gridTemplateRows = 'repeat(6,1fr)';
      boardEl.style.gap = '8px';
      renderBoard();
    })();
  </script>
</body>
</html>